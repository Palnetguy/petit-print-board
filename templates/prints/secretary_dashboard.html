{% extends 'base.html' %} {% block title %}Secretary Dashboard - Petit
PrintBoard{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="mb-4">
      <i class="fas fa-user-shield me-2"></i>Secretary Dashboard
    </h2>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="stat-card pending">
      <div class="icon">
        <i class="fas fa-clock"></i>
      </div>
      <h3>{{ pending_count }}</h3>
      <p>Pending Requests</p>
    </div>
  </div>

  <div class="col-md-6 mb-3">
    <div class="stat-card printed">
      <div class="icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>{{ printed_count }}</h3>
      <p>Total Printed</p>
    </div>
  </div>
</div>

<!-- Pending Requests Queue -->
<div class="table-container">
  <h3 class="table-title">
    <i class="fas fa-list-ul me-2"></i>Pending Print Queue
  </h3>

  {% if pending_requests %}
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>Teacher</th>
          <th>File Name</th>
          <th>Deadline</th>
          <th>Copies</th>
          <th>Notes</th>
          <th>Submitted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for request in pending_requests %}
        <tr {% if request.is_urgent %}class="table-danger" {% endif %}>
          <td>
            <i class="fas fa-user me-2"></i>
            {{ request.teacher.get_full_name|default:request.teacher.username }}
          </td>
          <td>
            <i class="fas fa-file-pdf me-2"></i>{{ request.filename }} 
            {% if request.is_urgent %}
            <span class="badge badge-urgent ms-2">
              <i class="fas fa-exclamation-triangle me-1"></i>URGENT
            </span>
            {% endif %}
          </td>
          <td>{{ request.deadline|date:"M d, Y H:i" }}</td>
          <td>{{ request.copies }}</td>
          <td>
            {% if request.notes %}
            <small>{{ request.notes|truncatewords:5 }}</small>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>{{ request.created_at|date:"M d, H:i" }}</td>
          <td>
            <a
              href="{% url 'download_file' request.id %}"
              class="btn btn-sm btn-primary me-1"
              title="Download"
            >
              <i class="fas fa-download"></i>
            </a>
            <a
              href="{% url 'mark_printed' request.id %}"
              class="btn btn-sm btn-success"
              title="Mark as Printed"
            >
              <i class="fas fa-check"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted text-center py-4">
    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
    No pending print requests. All caught up!
  </p>
  {% endif %}
</div>

<!-- Recently Printed -->
<div class="table-container">
  <h3 class="table-title">
    <i class="fas fa-check-double me-2"></i>Recently Printed (Last 20)
  </h3>

  {% if printed_requests %}
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>Teacher</th>
          <th>File Name</th>
          <th>Copies</th>
          <th>Printed At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for request in printed_requests %}
        <tr>
          <td>
            <i class="fas fa-user me-2"></i>
            {{ request.teacher.get_full_name|default:request.teacher.username }}
          </td>
          <td><i class="fas fa-file-pdf me-2"></i>{{ request.filename }}</td>
          <td>{{ request.copies }}</td>
          <td>{{ request.printed_at|date:"M d, Y H:i" }}</td>
          <td>
            <a
              href="{% url 'download_file' request.id %}"
              class="btn btn-sm btn-primary"
              title="Download"
            >
              <i class="fas fa-download"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted text-center py-4">
    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
    No printed requests yet.
  </p>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  // WebSocket connection for secretary notifications
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl =
    wsScheme + "://" + window.location.host + "/ws/notifications/secretary/";
  console.log("Connecting to WebSocket:", wsUrl);

  const socket = new WebSocket(wsUrl);

  socket.onopen = function (e) {
    console.log("âœ… WebSocket connected successfully");
  };

  socket.onmessage = function (e) {
    console.log("ðŸ“¨ Message received:", e.data);
    const data = JSON.parse(e.data);

    if (data.type === "new_request") {
      console.log("ðŸ”” New request notification:", data);
      showNotification(
        "New Print Request!",
        `From ${data.teacher}: ${data.filename}<br>Deadline: ${data.deadline}`,
        "primary"
      );
      setTimeout(() => location.reload(), 2000);
    }
  };

  socket.onerror = function (error) {
    console.error("âŒ WebSocket error:", error);
  };

  socket.onclose = function (e) {
    console.error("ðŸ”Œ WebSocket closed:", e.code, e.reason);
    setTimeout(() => location.reload(), 5000);
  };

  function showNotification(title, message, type) {
    const container = document.getElementById("notificationContainer");
    const notification = document.createElement("div");
    notification.className = "notification-popup show";
    notification.innerHTML = `
            <div class="icon text-${type}">
                <i class="fas fa-bell"></i>
            </div>
            <h5 class="mb-2">${title}</h5>
            <p class="mb-0">${message}</p>
        `;
    container.appendChild(notification);

    // Play notification sound
    const audio = new Audio(
      "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCd+zPDTgjMGHm7A7+OZUQ4SV7Dm67ViFg5HnuH1wG8iBS1+0O/gkj4KF2S56OmfUhALT6Pj8bhnHQU2jdXpyHkqBSt2xu/ijz0KF2K25+afWRALUabg77hjHgU3kdTux3ksBChzxe/ijz0KGGa65OalXBALUKDd77hmHwU8kdTuxXgpBSZ0xO/hizsKGGK15+adWhALU6Hc77hoHwU7k9Puw3YoBSZ0w+/ijz4KGmW75+adWhAMUqHc8LdoHgU7lNTww3YpBSh1w/DijzsJGGS75OamXBELU6Da8bdnHgU7ktPww3YpBSZ1xO/hizsJGWW75+emXRENUqDa8LdoHgQ7k9Tvw3YqBSZ0w+7gizsJGGS85Oamv4DB"
    );
    audio.volume = 0.5;
    audio.play().catch(() => {});

    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // Request browser notification permission
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
</script>
{% endblock %}
